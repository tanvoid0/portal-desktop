name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
      release_type:
        description: 'Release type'
        type: choice
        options:
          - release
          - beta
        default: release

jobs:
  # Extract version from tauri.conf.json
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.release_type.outputs.type }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Extract version from tauri.conf.json
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Determine release type
        id: release_type
        run: |
          if [ -n "${{ github.event.inputs.release_type }}" ]; then
            TYPE="${{ github.event.inputs.release_type }}"
          elif [[ "${{ github.ref }}" == *"beta"* ]] || [[ "${{ github.ref }}" == *"alpha"* ]]; then
            TYPE="beta"
          else
            TYPE="release"
          fi
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "Release Type: $TYPE"

  build-linux:
    needs: prepare
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git operations
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu
      
      - name: Configure git for HTTPS (prevent SSH failures)
        run: |
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://".insteadOf git://
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials
      
      - name: Configure Cargo to use HTTPS for git
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << 'EOF'
          [net]
          git-fetch-with-cli = true
          [url "https://github.com/"]
          insteadOf = "ssh://git@github.com/"
          [url "https://github.com/"]
          insteadOf = "git@github.com:"
          EOF
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
            src-tauri/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          GIT_ASKPASS: "echo"
          GIT_TERMINAL_PROMPT: "0"
          GIT_CONFIG_GLOBAL: "/dev/null"
          GIT_CONFIG_SYSTEM: "/dev/null"
      
      - name: Build application
        run: |
          pnpm build
          pnpm tauri build --target x86_64-unknown-linux-gnu
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          GIT_ASKPASS: "echo"
          GIT_TERMINAL_PROMPT: "0"
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"
      
      - name: Rename artifacts
        run: |
          chmod +x scripts/*.sh
          mkdir -p build-output
          VERSION="${{ needs.prepare.outputs.version }}" \
          RELEASE_TYPE="${{ needs.prepare.outputs.release_type }}" \
          ./scripts/rename-artifacts.sh linux || true
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linux-artifacts
          path: |
            build-output/*.deb
            build-output/*.AppImage
          retention-days: 90
          if-no-files-found: warn
